### CRDT 同步协议

| 简述             | 参数                                    | 场景                                                         | 内部机制说明                                                 |
| :--------------- | :-------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| CRDT.PSYNC       | <repl_id>  <offset>                     | CRDT Redis 向 peer 发起同步请求, 同 PSYNC 协议会收到全量同步 FULLRESYNC <repl_id> <offset>增量同步 CONTINUE <repl_id> | 发送出去的 repl_id, offset 来源来自 CRDT_Master_Instance 对象中, hold 的 cached_master (repl_id, reploff)如果没有, 则发送 ? -1接收到 |
| CRDT.OVC         | <gid> <vector-clock>                    | CRDT Redis 定时向 peer 发送自己进程的 vector clock           | OVC 的含义是 observed vector clock (可被观测的 vector clock)用于内部的 gc 机制, peer 之间通过接收对方发来的 CRDT.OVC 命令, 计算可以被 GC 对象的最小 vector clock |
| CRDT.merge_start | <gid> <vector-clock> <repl_id>          | CRDT_Master开始发送全量同步                                  | Peer之间全量同步, 下游 CRDT_SLAVE 接收到 FULLRESYNC 之后上游 CRDT_MASTER 从 Merge_start 开始, 标识全量同步开始 |
| CRDT.merge       | <gid> <key> <RDB-based-val>             | CRDT Master 发送key 相关的RDB内容, 包含value (module-object)expire timetombstone (如果有的话) | CRDT Redis 为了保证可用性, 将全量同步从 RDB 文件的方式, 转换为多个 CRDT.Merge 命令从而增加客户端访问 redis 的可用时间 |
| CRDT.merge_del   | <gid> <key> <RDB-based-val>             | CRDT Master 发送 key 对应的 tombstonekey 对应的 value 不存在仅存在 key 对应的 tombstone | 同上                                                         |
| CRDT.merge_end   | <gid> <vector-clock> <repl_id> <offset> | 收到 MergeEnd 表示全量同步结束, 此时, Redis将对应的 repl_id 以及 offset 赋值给 client 的属性将同步状态标记为 REPL_CONNECTED发送 CRDT.replconf ack-vc 通知 master 同步完毕 | CRDT Master 在全量同步结束的情况下发送 merge_end 标识        |
| CRDT.replconf    | listening-portcapaackmin-vcack-vc       | min-vcCRDT Slave 发送给 CRDT Master发送 CRDT.PSYNC 之前标识当前 CRDT Slave 的进程 vector clockack-vcCRDT Slave 发送给 CRDT Master处理完 CRDT.merge_end 之后标识全量同步成功完成 | min-vc 的机制:CRDT-Redis 之间的全量同步, 可以根据逻辑时钟(vector-clock)减少发送的数量, 从而达到减少 CPU/网络 资源加快全量同步时间的目的, min-vc 标识了下游 CRDT Slave 的进程 vector clock在发送 merge 命令时, CRDT Master 只发送满足 min-vc 中, 超过自身 clock 的数据例如:min-vc 是 1:120;2:100本节点的 gid 是 2则发送的 merge 命令, 只包含值的 vector-clock 对应 gid 有 2, 且 >= 100 的值 |
| CRDT.authGid     | <gid>                                   | 用于 Master-Slave 之间的同步为了兼容 master 是普通 redis 的场景 | 用于确认 Master-Slave 是否是 CRDT 的 redisslave 收到回复 OK, 则认为 master 是 CRDT 的 redismaster 收到该命令, 则认为 slave 是 CRDT 的 redis |
| CRDT.auth        | <namespace> <gid>                       | 用于 Peer 之间的同步                                         | 在实践中, 为了防止有不同的 IDC 之间的 redis, 双向同步关系搭建错误导致的数据错误, 无法修复的问题, 增加了namespace 的概念双向同步过程中, 需要校验两者是否对齐自身的 namespacepeer 发送过来的 namespace |
| CRDT.peer.change | <gid> <repl-id>                         | 用于 Master 发送给 slavePeer Master 的站点, 发生Master-Slave本站点作为 CRDT Slave 增量同步成功收到 CONTINUE <repl_id>, 但是此时 repl_id 发生变化Master 需要通知 Slave, 对应 <gid> 的 peer master, <repl_id> 发生了变更 | Master-Slave 切换Master-Master 增量同步Replication-ID 变化此时, Master 向 Master-Slave 的流中, 插入这样一条命令, 用来通知 slavepeer replication-id 的变化这样保证了状态的一致性由于是append 到流里面的, 所以, 状态和数据是对的上的 |